#!groovy

def mvnVersion = 'MVN_354'

node {
    stage('Checkout') {
            deleteDir()
            checkout scm
            withMaven(maven: mvnVersion) {
                sh "mvn clean install -Dmaven.test.skip=true"
            }
    }
    stage('Build') {
            withMaven(maven: mvnVersion) {
                sh "mvn clean install -Dmaven.test.skip=true"
            }
            stash name: "workspace"
    }
    stage('Test & Analyse') {
            parallel (
                test: { 
                    node('test') {
                      withMaven(maven: mvnVersion) {
                        unstash "workspace"
                        sh "mvn test" 
                        stash name: "test"
                    }}
                },
                analyse: { 
                    node('analyse') {
                      withMaven(maven: mvnVersion) {
                        unstash "workspace"
                        sh "mvn findbugs:findbugs" 
                        sh "mvn checkstyle:checkstyle"
                        sh "mvn pmd:pmd"
                        stash name: "analyse"
                    }}
                },        
                docu: { 
                    node('docu') {
                      withMaven(maven: mvnVersion) {
                        unstash "workspace"
                        sh "mvn javadoc:javadoc -Dmaven.javadoc.failOnError=false"
                        stash name: "docu"
                    }}
                }
            )
    }
    
    stage('report') {
        unstash "test"
        unstash "analyse"
        unstash "docu"
    
        junit 'target/surefire-reports/TEST-*.xml'
        findbugs pattern: 'target/findbugsXml.xml'
        checkstyle pattern: 'target/checkstyle-result.xml'
        pmd pattern: 'target/pmd.xml'    
    }
    
}
